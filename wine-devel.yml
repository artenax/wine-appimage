version: 1

script:
  # Remove any previous build cache data
  - rm -rf AppDir || true
  - mkdir -p AppDir/opt/libc/usr/{lib,lib32} appimage-builder-cache
  - cp wrapper AppDir
  - |-

    # extracting *tar.xz...
    (cd AppDir; find ../cache -type f -name '*tar.xz' -exec tar --warning=no-unknown-keyword -xJf {} \;)

    # extracting *tar.zst...
    (cd AppDir; find ../cache -type f -name '*tar.zst' -exec tar --warning=no-unknown-keyword --zstd -xf {} \;)

    # wineworkdir cleanup
    (cd AppDir; rm -rf include; rm usr/{lib,lib32}/{*.a,*.o,pkgconfig}; rm -rf usr/share/{doc,emacs,gtk-doc,java,licenses,man,info,pkgconfig})

    (cd AppDir/opt/libc/usr/lib/; mv ../../../../usr/lib/ld-*.so* . ; cd .. ; cd lib32 ; mv ../../../../usr/lib32/ld-*.so* .)

    sed -i -E 's,(^.+"library_path": ")/.*/,\1,' AppDir/usr/share/vulkan/icd.d/*.json

  - cp nvidia_icd.json AppDir/usr/share/vulkan/icd.d/

AppDir:
  path: ./AppDir

  app_info:
    id: org.winehq.wine
    name: wine
    icon: wine
    version: devel
    exec: usr/bin/bash
    exec_args: $APPDIR/wrapper $@

  files:
    exclude:
      - usr/lib/gconv
      - usr/lib/audit
      - usr/lib32/gconv
      - usr/lib32/audit
      - usr/share/include
      - usr/share/man
      - usr/share/doc/*/README.*
      - usr/share/doc/*/changelog.*
      - usr/share/doc/*/NEWS.*
      - usr/share/doc/*/TODO.*

  runtime:
    env:
      PATH: $APPDIR/usr/lib/gstreamer1.0/gstreamer-1.0:$APPDIR/usr/lib32/gdk-pixbuf-2.0:$APPDIR/usr/libexec:$APPDIR/usr/bin:$APPDIR/usr/sbin:$APPDIR/usr/lib32/glib-2.0:$APPDIR/usr/lib32/gstreamer1.0/gstreamer-1.0:$APPDIR/bin:$APPDIR/usr/lib/glib-2.0:$APPDIR/usr/lib/gdk-pixbuf-2.0
      APPDIR_LIBRARY_PATH: $APPDIR/usr/lib:$APPDIR/usr/lib/pulseaudio:$APPDIR/usr/lib/alsa-lib:$APPDIR/usr/lib32:$APPDIR/usr/lib32/pulseaudio:$APPDIR/usr/lib32/alsa-lib
      LIBC_LIBRARY_PATH: $APPDIR/opt/libc/usr/lib32:$APPDIR/opt/libc/usr/lib
      GST_REGISTRY_REUSE_PLUGIN_SCANNER: no
      GST_PLUGIN_SCANNER: $APPDIR/usr/lib32/gstreamer1.0/gstreamer-1.0/gst-plugin-scanner
      GST_PTP_HELPER: $APPDIR/usr/lib32/gstreamer1.0/gstreamer-1.0/gst-ptp-helper
      GDK_PIXBUF_MODULEDIR: $APPDIR/usr/lib32/gdk-pixbuf-2.0/2.10.0/loaders
      GDK_PIXBUF_MODULE_FILE: $APPDIR/usr/lib32/gdk-pixbuf-2.0/2.10.0/loaders.cache
      GSETTINGS_SCHEMA_DIR: $APPDIR/usr/share/glib-2.0/schemas
      LIBVA_DRIVERS_PATH: $APPDIR/usr/lib/dri:$APPDIR/usr/lib32/dri

  test:
    debian:
      image: appimagecrafters/tests-env:debian-stable
      command: "./AppRun --version"
      use_host_x: True
    centos:
      image: appimagecrafters/tests-env:centos-7
      command: "./AppRun --version"
      use_host_x: True
    arch:
      image: appimagecrafters/tests-env:archlinux-latest
      command: "./AppRun --version"
      use_host_x: True
    fedora:
      image: appimagecrafters/tests-env:fedora-30
      command: "./AppRun --version"
      use_host_x: True
    ubuntu:
      image: appimagecrafters/tests-env:ubuntu-xenial
      command: "./AppRun --version"
      use_host_x: True

AppImage:
  update-information: 'gh-releases-zsync|mmtrt|WINE_AppImage|continuous-testing|wine-devel*.AppImage.zsync'
  sign-key: None
  arch: x86_64

